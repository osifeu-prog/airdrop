#!/usr/bin/env python3
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]

BAD_MARKERS = [
    b"\xef\xbb\xbf",  # UTF-8 BOM (U+FEFF)
    b"<<<<<<< ", b"=======", b">>>>>>> ",
]

def fail(msg: str):
    print(msg, file=sys.stderr)
    sys.exit(1)

def main():
    # Check staged files only (best effort). If git isn't available, check all tracked-ish files.
    try:
        import subprocess
        out = subprocess.check_output(["git", "diff", "--cached", "--name-only", "-z"], cwd=ROOT)
        files = [ROOT / p.decode("utf-8") for p in out.split(b"\x00") if p]
    except Exception:
        files = [p for p in ROOT.rglob("*") if p.is_file() and ".git" not in p.parts]

    for p in files:
        if not p.exists() or p.is_dir():
            continue
        # skip binaries
        if p.suffix.lower() in {".png",".jpg",".jpeg",".gif",".webp",".ico",".zip",".pdf"}:
            continue
        data = p.read_bytes()
        for marker in BAD_MARKERS:
            if marker in data:
                fail(f"[pre-commit] Blocked commit: found forbidden marker {marker!r} in {p.relative_to(ROOT)}")
    return 0

if __name__ == "__main__":
    sys.exit(main())
